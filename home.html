<!DOCTYPE html>
<html>
<head>
    <title>Smart Retail Dashboard</title>
    <!-- This single line links to your beautiful, external stylesheet -->
    <link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="sidebar">
    <h2 id="welcome-user">Smart Retail</h2>
    <a href="#" onclick="loadSection('home')">üè† Home</a>
    <a href="#" onclick="loadSection('add')">‚ûï Add Product</a>
    <a href="#" onclick="logout()">üö™ Logout</a>
</div>

<div class="main-content">
    <!-- HOME SECTION -->
    <div id="home-section">
        <h2>Product Dashboard</h2>
        <div class="filters">
            <select id="filter-category" onchange="loadProducts()">
                <option value="All">All Categories</option>
                <option value="Perishable">Perishable</option>
                <option value="Non-Perishable">Non-Perishable</option>
            </select>
            <select id="filter-subcategory" onchange="loadProducts()">
                <option value="All">All Subcategories</option>
            </select>
        </div>
        <div class="product-grid" id="product-list"></div>
    </div>

    <!-- ADD PRODUCT SECTION -->
    <div id="add-section" style="display:none;">
        <h2>Add New Product</h2>
        <div class="form-container">
            <div class="form-group">
                <label for="pname">Product Name</label>
                <input type="text" id="pname" placeholder="e.g., Organic Milk">
            </div>
            <div class="form-group">
                <label for="pcat">Category</label>
                <select id="pcat">
                    <option value="Perishable">Perishable</option>
                    <option value="Non-Perishable">Non-Perishable</option>
                </select>
            </div>
            <div class="form-group">
                <label for="psubcat">Subcategory</label>
                <select id="psubcat"></select>
            </div>
            <div class="form-group">
                <label for="pprice">Price (‚Çπ)</label>
                <input type="number" id="pprice" placeholder="e.g., 120">
            </div>
            <div class="form-group">
                <label for="pstock">Current Stock</label>
                <input type="number" id="pstock" placeholder="e.g., 50">
            </div>
            <div class="form-group">
                <label for="pmfg">Manufacture Date</label>
                <input type="date" id="pmfg">
            </div>
            <div class="form-group">
                <label for="pexp">Expiry Date</label>
                <input type="date" id="pexp">
            </div>
            <button onclick="addProduct()" class="add-btn">Add Product</button>
        </div>
    </div>
</div>

<script src="data.js"></script>

<script>
    // --- AUTH & SETUP ---
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user || user.role !== 'manager') window.location.href = 'login.html';
    document.getElementById('welcome-user').textContent = `Welcome, ${user.name || 'Manager'}`;

    const subcategories = {
      Perishable: ["Meat and Poultry", "Fish and Seafood", "Dairy Products", "Eggs", "Fresh Fruits and Vegetables", "Cooked Foods"],
      "Non-Perishable": ["Canned Goods", "Dry Goods", "Packaged Snacks", "Condiments and Sauces", "Oils and Fats", "Powdered and Dehydrated Foods", "Nuts and Nut Butters"]
    };

    function loadSection(section) {
      ['home', 'add'].forEach(id => {
        document.getElementById(id + '-section').style.display = (id === section) ? 'block' : 'none';
      });
      if (section === 'home') loadProducts();
    }

    function logout() {
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    }

    // --- DYNAMIC PRICING & UTILITIES ---
    function calculateDynamicPrice(product) {
        const today = new Date();
        const expiry = new Date(product.expiryDate);
        const daysLeft = (expiry - today) / (1000 * 3600 * 24);
        if (daysLeft <= 0) return product.originalPrice * 0.5;
        if (daysLeft < 3) return product.originalPrice * 0.7;
        if (daysLeft < 7) return product.originalPrice * 0.85;
        return product.originalPrice;
    }

    function getExpiryCountdown(expiryDateStr) {
        const today = new Date();
        const expiryDate = new Date(expiryDateStr);
        const daysLeft = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        if (daysLeft < 0) return `<span style="color: red;">‚ö†Ô∏è Expired</span>`;
        if (daysLeft === 0) return `<span style="color: orange;">‚è≥ Expires today</span>`;
        if (daysLeft <= 3) return `<span style="color: orange;">‚è≥ ${daysLeft} day(s) left</span>`;
        return `<span style="color: green;">üïí ${daysLeft} day(s) left</span>`;
    }

    // --- CORE PRODUCT LOGIC (LOCALSTORAGE) ---
    function loadProducts() {
      const allProducts = JSON.parse(localStorage.getItem('products') || '[]');
      const category = document.getElementById('filter-category').value;
      const subcategory = document.getElementById('filter-subcategory').value;
      const list = document.getElementById('product-list');
      list.innerHTML = '';

      const filteredProducts = allProducts
        .filter(p => category === 'All' || p.category === category)
        .filter(p => subcategory === 'All' || p.subcategory === subcategory);
      
      filteredProducts.forEach(p => {
        const dynamicPrice = calculateDynamicPrice(p);
        list.innerHTML += `
          <div class="product-card">
            <h4>${p.name}</h4>
            <p>${p.category} > ${p.subcategory}</p>
            <p>MFG: ${new Date(p.manufactureDate).toLocaleDateString()}</p>
            <p>EXP: ${new Date(p.expiryDate).toLocaleDateString()}</p>
            <p>Original Price: ‚Çπ${p.originalPrice}</p>
            <p><strong>Dynamic Price: ‚Çπ${dynamicPrice.toFixed(2)}</strong></p>
            <p>${getExpiryCountdown(p.expiryDate)}</p>
            <button class="delete-btn" onclick="deleteProduct('${p._id}')">üóë Delete</button>
          </div>`;
      });
    }

    function addProduct() {
      const newProduct = {
        _id: `prod_${new Date().getTime()}`, // Unique ID
        name: document.getElementById('pname').value,
        category: document.getElementById('pcat').value,
        subcategory: document.getElementById('psubcat').value,
        originalPrice: +document.getElementById('pprice').value,
        currentStock: +document.getElementById('pstock').value,
        manufactureDate: document.getElementById('pmfg').value,
        expiryDate: document.getElementById('pexp').value
      };

      if (!newProduct.name || !newProduct.originalPrice) {
          alert("Product Name and Price are required.");
          return;
      }

      const allProducts = JSON.parse(localStorage.getItem('products') || '[]');
      allProducts.push(newProduct);
      localStorage.setItem('products', JSON.stringify(allProducts));

      alert('Product added successfully!');
      loadSection('home');
    }

    function deleteProduct(id) {
      if (confirm("Are you sure you want to delete this product?")) {
        let allProducts = JSON.parse(localStorage.getItem('products') || '[]');
        const updatedProducts = allProducts.filter(p => p._id !== id);
        localStorage.setItem('products', JSON.stringify(updatedProducts));
        alert('Product deleted successfully!');
        loadProducts();
      }
    }

    // --- EVENT LISTENERS ---
    document.getElementById('filter-category').addEventListener('change', function () {
      const selected = this.value;
      const sub = document.getElementById('filter-subcategory');
      sub.innerHTML = '<option value="All">All Subcategories</option>';
      if (subcategories[selected]) {
        sub.innerHTML += subcategories[selected].map(sc => `<option value="${sc}">${sc}</option>`).join('');
      }
      loadProducts();
    });
    
    document.getElementById('pcat').addEventListener('change', function () {
      const subcat = document.getElementById('psubcat');
      const selected = this.value;
      subcat.innerHTML = subcategories[selected].map(sc => `<option value="${sc}">${sc}</option>`).join('');
    });
    document.getElementById('pcat').dispatchEvent(new Event('change'));

    // --- INITIAL LOAD ---
    loadSection('home');
</script>
</body>
</html>
